# ì±„ê´‘ ë³´ìƒ ì €ì¥
@files = list_files('rewards')
foreach(@file in @files) {
  @file_path = "rewards/@file"
  @file_name_and_extension = _get_file_name_and_extension(@file)
  @file_name = @file_name_and_extension[0]
  @file_extension = @file_name_and_extension[1]
  if(@file_extension == 'json') {
    async_read_file(@file_path, closure(@content) {
      foreach(@mineral_name: @mineral_reward in json_decode(@content)) {
        #@namespace = "@file_name:@mineral_name"
        #@mineral_rewards[@namespace] = @mineral_reward
        @mineral_rewards[@mineral_name] = @mineral_reward
      }
    })
  }
}

proc _mineral_mine_event(@event, @player, @uuid, @players_data, @hp_blocks, @mineral_rewards, @skills_spec, @text, @server) {
  @player_data = @players_data[@uuid]
  # ë¶€ìˆœ ë¸”ëŸ­ ì„ ì–¸
  @mineral = @event['block']
  # ë¶€ìˆœ ë¸”ëŸ­ì´ ê´‘ë¬¼ì¼ì‹œ
  if(array_contains(array_keys(@mineral_rewards), @mineral)) {
    # ê´‘ë¬¼ ìŠ¤í™ ì„ ì–¸
    @mineral_reward = array_deep_clone(@mineral_rewards[@mineral])
    ## ê³¡ê´­ì´ ê´€ë ¨ ë°ì´í„° ì„ ì–¸
    # ê¸°ë³¸ ë°ì´í„° ì„ ì–¸
    @pickaxe_hardness = 0
    @mining_power = 0
    # ê³¡ê´­ì´ ê°•ë„ ë°ì´í„°
    @pickaxes_hardness = array(          # ìº˜ìˆ˜ìˆëŠ” ê´‘ë¬¼
      'WOODEN_PICKAXE': 1,   #ë‚˜ë¬´         (ëŒ)
      #                      #ëŒ           (ëŒ, êµ¬ë¦¬)
      'STONE_PICKAXE': 3,    #êµ¬ë¦¬         (ëŒ, êµ¬ë¦¬, ì² )
      'IRON_PICKAXE': 4,     #ì²            (ëŒ, êµ¬ë¦¬, ì² , ê¸ˆ)
      'GOLDEN_PICKAXE': 5,   #ê¸ˆ           (ëŒ, êµ¬ë¦¬, ì² , ê¸ˆ, ë‹¤ì´ì•„)
      'DIAMOND_PICKAXE': 6,  #ë‹¤ì´ì•„       (ëŒ, êµ¬ë¦¬, ì² , ê¸ˆ, ë‹¤ì´ì•„, ê³ ëŒ€íŒŒí¸)
      'NETHERITE_PICKAXE': 7 #ë„¤ë”ë¼ì´íŠ¸   (ëŒ, êµ¬ë¦¬, ì² , ê¸ˆ, ë‹¤ì´ì•„, ê³ ëŒ€íŒŒí¸)
    )
    if(!is_null(@player_data['item']['main_hand']) && array_contains(array_keys(@pickaxes_hardness), @player_data['item']['main_hand']['name'])) { // ê³¡ê´­ì´ë¡œ ì±„êµ´í• ì‹œ
      # ê³¡ê´­ì´ ì„ ì–¸
      @pickaxe = @player_data['item']['main_hand']
      # ê³¡ê´­ì´ ê°•ë„ ì„¤ì •
      @pickaxe_hardness = @pickaxes_hardness[@pickaxe['name']]
      if(!is_null(@pickaxe['meta'])) {
        if(@pickaxe_hardness == 1 && @pickaxe['meta']['model'] >= 8) {
          @pickaxe_hardness = 2 // ëŒ ê³¡ê´­ì´ ê°•ë„ ì¡°ì •
        }
        if(array_index_exists(@pickaxe['meta'], 'modifiers')) {
          foreach(@modifier in @pickaxe['meta']['modifiers']) {
            if(@modifier['attribute'] == 'HORSE_JUMP_STRENGTH') {
              # ì±„êµ´ ê°•ë„ ì„ ì–¸
              @mining_power = @modifier['amount']
              break()
            }
          }
        }
      }
    }
    # ìœ„ì¹˜ ì„ ì–¸ (ì•„ì´í…œ ë“œë ìœ„ì¹˜ ê¸°ì¤€)
    @location = array('x': @event['location']['x'] + 0.5, 'y': @event['location']['y'] + 0.5, 'z': @event['location']['z'] + 0.5, 'world': @event['location']['world'])
    # id ì„ ì–¸ (x.y.z.world)
    @id = array_implode(array(integer(@location['x']), integer(@location['y']), integer(@location['z']), @location['world']), '.')
    # í”¼í†µ ì„ ì–¸
    @max_hp = @mineral_rewards[@mineral]['hp']
    if(@pickaxe_hardness >= @mineral_rewards[@mineral]['hardness']) { // ê³¡ê´­ì´ë¡œ ìº˜ ìˆ˜ ìˆëŠ” ê´‘ë¬¼ì¼ì‹œ
      ## ìŠ¤í‚¬ ë¶ˆëŸ¬ì˜¤ê¸°
      # ê°•ì¸í•œ ì–´ê¹¨ ë°°ìˆ˜
      @mining_power_point = @player_data['skill_data']['tough_shoulder'][0]
      @mining_power_multiply = @skills_spec['tough_shoulder']['effect_by_point'][@mining_power_point]['multiply']
      @mining_power *= @mining_power_multiply
      # ì±„ê´‘ ìˆ™ë ¨ ë°°ìˆ˜
      @mining_mastery_multiply = 1
      if(array_index_exists(@mineral_reward, 'mastery')) {
        @mining_mastery_name = @mineral_reward['mastery']
        @mining_mastery_point = @player_data['skill_data'][@mining_mastery_name][0]
        @mining_mastery_multiply = @skills_spec[@mining_mastery_name]['effect_by_point'][@mining_mastery_point]['multiply']
      }
      # ì„ ê´‘ ë°°ìˆ˜
      @ore_selecting_multiply = 1
      switch(@location['world']) {
      case 'over':
        @ore_selecting_name = 'over_ore_selecting'
        break()
      case 'nether':
        @ore_selecting_name = 'nether_ore_selecting'
        break()
      default:
        @ore_selecting_name = null
        break()
      }
      if(!is_null(@ore_selecting_name)) {
        @ore_selecting_point = @player_data['skill_data'][@ore_selecting_name][0]
        @ore_selecting_multiply = @skills_spec[@ore_selecting_name]['effect_by_point'][@ore_selecting_point]['multiply']
      }
      # ìµœëŒ€ ë“œë ê°¯ìˆ˜ ë°°ìˆ˜ì— ì„ ê´‘ ìŠ¤í‚¬ ë°°ìˆ˜, ì¸ì²¸íŠ¸ ë°˜ì˜
      @max_drop_multiply = @ore_selecting_multiply
      if(@player_data['item']['enchantments']['main_hand'] == 'í–‰ìš´') {
        @max_drop_multiply += 1
      }
      # idê°€ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ê´‘ë¬¼ì´ ë‹¤ë¥¸ ê´‘ë¬¼ë¡œ ë°”ë€”ê²½ìš° ê¸°ë³¸ë°ì´í„°ë¡œ ì„¤ì •
      if(!array_index_exists(@hp_blocks, @id)) {
        @hp_blocks[@id] = array(
          'name': @mineral,
          'hp': @mineral_rewards[@mineral]['hp'],
          'reset_countdown': 3,
          'logs': array(
            'max_drop_multiplies': array(),
            'rank_quality_multiplies': array()
          )
        )
      } else if(@hp_blocks[@id]['name'] != @mineral) {
        @hp_blocks[@id] = array(
          'name': @mineral,
          'hp': @mineral_rewards[@mineral]['hp'],
          'reset_countdown': 3,
          'logs': array(
            'max_drop_multiplies': array(),
            'rank_quality_multiplies': array()
          )
        )
      }
      # old_hp ì„ ì–¸
      @old_hp = @hp_blocks[@id]['hp']
      # ì²´ë ¥ ê¹ê¸° (0ì´í•˜ë¡œ ë‚´ë ¤ê±°ë©´ 0ìœ¼ë¡œ ì„¤ì •) ë° @hp_block ê¸°íƒ€ ë°ì´í„° ê°±ì‹ 
      @hp_blocks[@id]['hp'] -= @mining_power
      if(@hp_blocks[@id]['hp'] < 0) {
        @hp_blocks[@id]['hp'] = 0
      }
      @hp_blocks[@id]['reset_countdown'] = 3
      # hp ì„ ì–¸
      @hp = @hp_blocks[@id]['hp']
      # ì„ ê´‘ ìˆ™ë ¨, ì±„êµ´ ìˆ™ë ¨ ê¸°ë¡
      @hp_blocks[@id]['logs']['max_drop_multiplies'][] = @max_drop_multiply
      @hp_blocks[@id]['logs']['rank_quality_multiplies'][] = @mining_mastery_multiply
      # ì±„êµ´ ë„ì¤‘ ì¼ì‹œ
      if(@hp > 0) {
        cancel()
        # ìˆ˜ë™ ë‚´êµ¬ë„ ê¹ê¸° (ìº”ìŠ¬ ê±¸ë ¤ ìˆì–´ì„œ ë‚´êµ¬ë„ ê¹ì•„ì¤˜ì•¼ í•¨)
        @item = @player_data['item']['main_hand']
        @slot = pheld_slot(@player)
        if(is_null(@item['meta']) || !array_index_exists(@item['meta'], 'damage')) {
          @damage = 0
        } else {
          @damage = @item['meta']['damage']
        }
        if(is_null(@item['meta']) || !array_index_exists(@item['meta'], 'enchants') || !array_index_exists(@item['meta']['enchants'], 'unbreaking')) {
          @unbreaking_level = 0
        } else {
          @unbreaking_level = @item['meta']['enchants']['unbreaking']['elevel']
        }
        @breaking_chance = 1 / (@unbreaking_level + 1)
        if(rand() < @breaking_chance) {
          if(is_null(@item['meta'])) {
            @item['meta'] = array('damage': @damage + 1)
          } else {
            @item['meta']['damage'] = @damage + 1
          }
          if(material_info(@item['name'], 'maxDurability') == @item['meta']['damage']) {
            play_entity_effect(puuid(@player), 'BREAK_EQUIPMENT_MAIN_HAND')
            @item = null
            set_inventory_item(puuid(@player), @slot, null)
          } else {
            set_inventory_item(puuid(@player), @slot, @item)
          }
          _update_item(@player, @uuid, array('main_hand': @item), @player_data, @skills_spec, @text)
        }
        # ì¸ë””ì¼€ì´í„° ë°ì´í„° ì„¤ì •
        @indicator_data  = array(
          'block': @mineral,
          'max_hp': @max_hp,
          'old_hp': @old_hp,
          'new_hp': @hp,
          'id': @id,
          'countdown': 7
        )
      } else { // ì±„êµ´ ì™„ë£Œì‹œ
        # ì„ ê´‘ ìˆ™ë ¨, ì±„ê´‘ ìˆ™ë ¨ í‰ê·  êµ¬í•˜ê¸° (ë†’ì€ ë ˆë²¨ ìœ ì €ê°€ ë§‰íƒ€ ì¹˜ê±°ë‚˜ í–‰ìš´ê³¡ ë§‰íƒ€ ë°©ì§€)
        @mining_mastery_multiply = average(@hp_blocks[@id]['logs']['rank_quality_multiplies']) 
        @max_drop_multiply = average(@hp_blocks[@id]['logs']['max_drop_multiplies'])
        # ì±„êµ´ ë°ì´í„° ì‚­ì œ
        array_remove(@hp_blocks, @id)
        # ì±„êµ´ ì™„ë£Œ ì†Œë¦¬
        play_named_sound(@location, array(
          'sound': 'minecraft:entity.player.levelup',
          'category': 'PLAYERS',
          'volume': 0.4,
          'pitch': 1.5
        ), @player)
        # ë£¨íŠ¸ í…Œì´ë¸” ì‹œìŠ¤í…œ
        @entries = @mineral_reward['loot_table']
        @total_weight = 0
        foreach(@key: @entry in @entries) {
          # ì±„ê´‘ ìˆ™ë ¨ ë°˜ì˜ (ì±„ê´‘ ìˆ™ë ¨ ìŠ¤í‚¬ ì—°ê´€ ì—†ëŠ” ê´‘ë¬¼ì¼ ê²½ìš° ë°°ìˆ˜ëŠ” 1ì„)
          @entries[@key]['weight'] += @entry['quality'] * @mining_mastery_multiply
          @total_weight += @entry['weight']
        }
        # ë“œë ê°¯ìˆ˜ ì„¤ì •
        @qty = integer(round(@mineral_reward['default_qty'] * @max_drop_multiply * rand()))
        if(@qty < @mineral_reward['default_qty']) { @qty = @mineral_reward['default_qty']}
        # ë“œë ê°¯ìˆ˜ ë§Œí¼ ì•„ì´í…œ ë–¨êµ¬ê¸°
        for(@i = 0, @i < @qty, @i++) {
          @result_weight = @total_weight * round(rand(), 5)
          @min_weight = 0
          foreach(@entry in @entries) {
            @max_weight = @min_weight + @entry['weight']
            if(@max_weight > @result_weight) {
              drop_item(@location, @entry['item'], false)
              if(array_index_exists(@entry, 'broadcast') && @entry['broadcast']) {
                @message = @player.'ë‹˜ê»˜ì„œ '.strip_colors(@entry['item']['meta']['display']).'ë¥¼ ì±„êµ´í•˜ì…¨ìŠµë‹ˆë‹¤.'
                @prefix = 'ğŸ‰'
                _send_instance_tooltip_system_broadcast(@player, @uuid, @prefix, @message, 5, 6)
              }
              _logging('mine', time(), @server, @location, @player, @uuid, @entry['item'])
              break()
            } else {
              @min_weight = @max_weight
            }
          }
        }
        # ê²½í—˜ì¹˜ ë“œë
        if(@player_data['item']['enchantments']['main_hand'] == 'ê²½í—˜') {
          _drop_arcanelevel_random_experience(@location, @mineral_reward['arcanelevel']['default'], @mineral_reward['arcanelevel']['extra'])
          _drop_arcanelevel_random_experience(@location, @mineral_reward['arcanelevel']['default'], @mineral_reward['arcanelevel']['extra'])
        } else {
          _drop_arcanelevel_random_experience(@location, @mineral_reward['arcanelevel']['default'], @mineral_reward['arcanelevel']['extra'])
        }
        # íŠœë‚˜ë ˆë²¨
        _give_tunalevel_random_experience(@uuid, @player_data, @mineral_reward['tunalevel']['default'], @mineral_reward['tunalevel']['extra'], @text)
        # ì•„ì´í…œ, ê²½í—˜ì¹˜ ìˆ˜ë™ìœ¼ë¡œ ë–¨êµ¬ê¸° ë•Œë¬¸ì— ëª¨ë””í”¼ ì´ë²¤íŠ¸ë¡œ ì´ë²¤íŠ¸ ê²°ê³¼ ìˆ˜ì •
        modify_event('drops', array())
        modify_event('xp', 0)
        # ì¸ë””ì¼€ì´í„° ë°ì´í„° ì„¤ì •
        @indicator_data = array(
          'block': @mineral,
          'max_hp': @max_hp,
          'old_hp': @old_hp,
          'new_hp': @hp,
          'id': @id,
          'countdown': 1
        )
      }
    } else { # ê³¡ê´­ì´ ê°•ë„ê°€ ë¶€ì¡±í• ì‹œ
      # hp ë³€í™” ì—†ì–´ ë³´ì´ë„ë¡ @hp ì„ ì–¸
      if(array_index_exists(@hp_blocks, @id)) {
        @old_hp = @hp_blocks[@id]['hp']
        @hp = @hp_blocks[@id]['hp']
      } else {
        @old_hp = @mineral_rewards[@mineral]['hp']
        @hp = @mineral_rewards[@mineral]['hp']
      }
      # ì¸ë””ì¼€ì´í„° ë°ì´í„° ì„¤ì •
      @indicator_data = array(
        'block': @mineral,
        'max_hp': @max_hp,
        'old_hp': @old_hp,
        'new_hp': @hp,
        'id': @id,
        'countdown': 3
      )
      cancel()
    }
    #ì¸ë””ì¼€ì´í„° ë³´ì—¬ì£¼ê¸°
    _show_indicator(@uuid, @player_data, @indicator_data, @text)
    #ìº”ìŠ¬ì€ ì•ˆë¬ëŠ”ë° ì •ìƒì ìœ¼ë¡œ ìº”ê²Œ ì•„ë‹ë–¼ í…œ ì•ˆë–¨êµ¬ë„ë¡ í•´ì£¼ëŠ” ì½”ë“œ
    modify_event('drops', array())
  }
}