# ë°ìŠ¤íŒ¨ë„í‹° ì €ì¥
@files = list_files('death_penalties')
foreach(@file in @files) {
  @file_path = "death_penalties/@file"
  @file_name_and_extension = _get_file_name_and_extension(@file)
  @file_name = @file_name_and_extension[0]
  @file_extension = @file_name_and_extension[1]
  if(@file_extension == 'json') {
    async_read_file(@file_path, closure(@content) {
      @death_penalties_multiply[@file_name] = json_decode(@content)
    })
  }
}

proc _apply_death_penalty(@player, @uuid, @death_penalties_multiply, @players_data, @server) {
  @inventory = get_inventory(@uuid)
  modify_event('death_message', null)
  if(@server != 'main') {
    if(@players_data[@uuid]['item']['enchantments']['armor'] == 'ê·€ì†') {
      tmsg(@player, 'ğŸ’€ Â§7ë°ìŠ¤íŒ¨ë„í‹°ë¡œ ì•½ '.integer(round((1 - @death_penalties_multiply[@server]['default']['multiply']) * 50)).'%ì˜ ì•„ì´í…œì´ ì†Œì‹¤ë˜ì—ˆìŠµë‹ˆë‹¤..')
    } else {
      tmsg(@player, 'ğŸ’€ Â§7ë°ìŠ¤íŒ¨ë„í‹°ë¡œ ì•½ '.integer(round((1 - @death_penalties_multiply[@server]['default']['multiply']) * 100)).'%ì˜ ì•„ì´í…œì´ ì†Œì‹¤ë˜ì—ˆìŠµë‹ˆë‹¤..')
    }
  }
  foreach(@key: @item in @inventory) {
    if(!is_null(@item) && @item['name'] != 'STRUCTURE_VOID') {
      if(array_index_exists(@death_penalties_multiply[@server], @item['name'])) {
        @death_penalty_multiply = @death_penalties_multiply[@server][@item['name']]
      } else {
        @death_penalty_multiply = @death_penalties_multiply[@server]['default']
      }
      if(@players_data[@uuid]['item']['enchantments']['armor'] == 'ê·€ì†') {
        @death_penalty_multiply['multiply'] += (1 - @death_penalty_multiply['multiply']) / 2
        @death_penalty_multiply['deviation'] = @death_penalty_multiply['deviation'] / 2
      }
      @max_durability = material_info(@item['name'], 'maxDurability')
      if(@max_durability == 0) {
        @inventory[@key]['qty'] = integer(_multiply_value(@item['qty'], @death_penalty_multiply['multiply'], @death_penalty_multiply['deviation']))
      } else {
        #ë‚´êµ¬ë„ ë°˜ì˜
        @new_damage = integer(_multiply_value(@max_durability, 1 - @death_penalty_multiply['multiply'], @death_penalty_multiply['deviation']))
        if(is_null(@item['meta'])) {
          @durability = @new_damage
          @inventory[@key]['meta'] = array()
        } else {
          @durability = @item['meta']['damage'] + @new_damage
        }
        if(@durability < @max_durability) {
          @inventory[@key]['meta']['damage'] = @durability
        } else {
          @inventory[@key] = null
        }
      }
    }
  }
  set_inventory(@uuid, @inventory)
}

// ì‚¬ë§ì‹œ ì¶”ê°€ì ìœ¼ë¡œ í”„ë¡œì‹œì € ì‚¬ìš©ì‹œ event.msë¡œ ì˜®ê²¨ì•¼ í•¨
bind('player_death', null, null, @event, @death_penalties_multiply, @players_data, @server) {
  @player = @event['player']
  @uuid = puuid(@player)
  _apply_death_penalty(@player, @uuid, @death_penalties_multiply, @players_data, @server)
}

# í•„ë“œ íš¨ê³¼, ë§ˆë²•ê²½í—˜ì¹˜ íšë“ ì¡°ì • ë“±
# íŠ¹ì • ì›”ë“œì—ì„œ ë°œìƒí•˜ëŠ”ê²ƒ ì²˜ë¦¬